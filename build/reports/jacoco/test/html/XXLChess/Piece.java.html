<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Piece.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">chess_origin</a> &gt; <a href="index.source.html" class="el_package">XXLChess</a> &gt; <span class="el_source">Piece.java</span></div><h1>Piece.java</h1><pre class="source lang-java linenums">package XXLChess;

import java.util.concurrent.CopyOnWriteArrayList;
import java.util.Arrays;
import java.util.List;
import processing.core.PApplet;
import processing.core.PImage;


public abstract class Piece extends GameObject {
  public static final int GRIDNUM = Board.GRIDNUM;
  public static final int GRIDSIZE = Board.GRIDSIZE;
  public static PImage BLACK_QUEEN_IMAGE;
  public static PImage WHITE_QUEEN_IMAGE;
  public static final int FPS = 60;
  public static final int DIRECTION_NUMBER = 4;
  protected static final int HORSE_RANGE = 2;
  protected static final int CAMEL_RANGE = 3;
<span class="fc" id="L19">  public static final int[] Y_STRAIGHT_DIRECTION = {-1, 0, 1, 0};</span>
<span class="fc" id="L20">  public static final int[] X_STRAIGHT_DIRECTION = {0, 1, 0, -1};</span>
<span class="fc" id="L21">  public static final int[] Y_DIAGONAL_DIRECTION = {-1, -1, 1, 1};</span>
<span class="fc" id="L22">  public static final int[] X_DIAGONAL_DIRECTION = {1, -1, -1, 1};</span>
  private static double movementSpeed;
  protected static int pawnDirection;
  protected static int movementTime;

  private double overrideSpeed;
  protected float destX;
  protected float destY;
  protected float displayX;
  protected float displayY;
  protected Square curSquare;
  protected boolean isMoved;
  protected double direction;
  protected String code;
  protected Piece pinPiece;
  protected boolean moving;
  protected double value;
  protected PImage sprite;
<span class="fc" id="L40">  protected CopyOnWriteArrayList&lt;Move&gt; validMoves = new CopyOnWriteArrayList&lt;Move&gt;();</span>
<span class="fc" id="L41">  protected CopyOnWriteArrayList&lt;Move&gt; preLegalMoves = new CopyOnWriteArrayList&lt;Move&gt;();</span>
  protected boolean isWhite;

  public Piece(float x, float y, String code, Square curSquare) {
<span class="fc" id="L45">    super(x, y);</span>
<span class="fc" id="L46">    this.curSquare = curSquare;</span>
<span class="fc" id="L47">    destX = x;</span>
<span class="fc" id="L48">    destY = y;</span>
<span class="fc" id="L49">    displayX = x;</span>
<span class="fc" id="L50">    displayY = y;</span>
<span class="fc" id="L51">    direction = 0;</span>
<span class="fc" id="L52">    this.code = code;</span>
<span class="fc bfc" id="L53" title="All 2 branches covered.">    if (code.charAt(0) == 'w') {</span>
<span class="fc" id="L54">      this.isWhite = true;</span>
    } else {
<span class="fc" id="L56">      this.isWhite = false;</span>
    }
<span class="fc" id="L58">    this.overrideSpeed = 0;</span>
<span class="fc" id="L59">    isMoved = false;</span>
<span class="fc" id="L60">  }</span>

  public static void setMoveStat(double movementSpeed, int movementTime, int pawnDirection) {
<span class="fc" id="L63">    Piece.pawnDirection = pawnDirection;</span>
<span class="fc" id="L64">    Piece.movementSpeed = movementSpeed;</span>
<span class="fc" id="L65">    Piece.movementTime = movementTime;</span>
<span class="fc" id="L66">  }</span>

  /**
   * Sets the object's sprite.
   *
   * @param sprite The new sprite to use.
   */
  public void setSprite(PApplet app) {
<span class="nc" id="L74">    String dir = &quot;src/main/resources/XXLChess/&quot; + code + &quot;.png&quot;;</span>
<span class="nc" id="L75">    this.sprite = app.loadImage(dir);</span>
<span class="nc" id="L76">    this.sprite.resize(GRIDSIZE, GRIDSIZE);</span>

<span class="nc bnc" id="L78" title="All 2 branches missed.">    if (WHITE_QUEEN_IMAGE == null) {</span>
<span class="nc" id="L79">      WHITE_QUEEN_IMAGE = app.loadImage(&quot;src/main/resources/XXLChess/wq.png&quot;);</span>
<span class="nc" id="L80">      BLACK_QUEEN_IMAGE = app.loadImage(&quot;src/main/resources/XXLChess/bq.png&quot;);</span>
    }
<span class="nc" id="L82">  }</span>

  public void setPromotedSprite() {
<span class="nc bnc" id="L85" title="All 2 branches missed.">    this.sprite = isWhite ? WHITE_QUEEN_IMAGE : BLACK_QUEEN_IMAGE;</span>
<span class="nc" id="L86">    this.sprite.resize(GRIDSIZE, GRIDSIZE);</span>
<span class="nc" id="L87">  }</span>

  public Square getSquare() {
<span class="fc" id="L90">    return curSquare;</span>
  }

  public void startMoving() {
<span class="fc" id="L94">    displayX = destX;</span>
<span class="fc" id="L95">    displayY = destY;</span>
<span class="fc" id="L96">    this.direction = Math.atan2(destY - this.y, destX - this.x);</span>
<span class="fc" id="L97">    double distance = Math.sqrt(Math.pow(displayX - this.x, 2) + Math.pow(displayY - this.y, 2));</span>
<span class="fc" id="L98">    double time = distance / Piece.movementSpeed;</span>
<span class="pc bpc" id="L99" title="1 of 2 branches missed.">    if (time &gt;= movementTime * FPS - 1) {</span>
<span class="nc" id="L100">      overrideSpeed = distance / ((movementTime * FPS) - 1);</span>
    }

<span class="fc" id="L103">  }</span>

  public void setPinPiece(Piece pin) {
<span class="fc" id="L106">    pinPiece = pin;</span>
<span class="fc" id="L107">  }</span>

  public List&lt;Move&gt; getValidMoves() {
<span class="fc" id="L110">    return validMoves;</span>
  }

  public List&lt;Move&gt; getPreLegalMoves() {
<span class="nc" id="L114">    return preLegalMoves;</span>
  }

  public String getCode() {
<span class="fc" id="L118">    return code;</span>
  }

  public void setMoved(boolean moved) {
<span class="fc" id="L122">    this.isMoved = moved;</span>
<span class="fc" id="L123">  }</span>

  public boolean isMoved() {
<span class="fc" id="L126">    return isMoved;</span>
  }

  public void displayMoveSet() {
<span class="nc bnc" id="L130" title="All 2 branches missed.">    for (Move m : validMoves) {</span>
<span class="nc" id="L131">      Square s = m.getEndSquare();</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">      if (m.getFlag() == Move.CAPTURE) {</span>
<span class="nc" id="L133">        s.setOnCapture(true);</span>
      } else {
<span class="nc" id="L135">        s.setOnPieceWay(true);</span>
      }
<span class="nc" id="L137">    }</span>
<span class="nc" id="L138">  }</span>


  protected void straightMove(Board curBoard, int dirX, int dirY, int range) {
<span class="fc" id="L142">    int kingOccur = 0;</span>
<span class="fc" id="L143">    int occur = 0;</span>
<span class="fc" id="L144">    Piece prevPiece = this;</span>
<span class="fc" id="L145">    CopyOnWriteArrayList&lt;Piece&gt;[] attackers = curBoard.getAttackers();</span>
<span class="fc" id="L146">    Square[][] squares = curBoard.getSquareMat();</span>
<span class="fc bfc" id="L147" title="All 2 branches covered.">    for (int i = 1; i &lt;= range; i++) {</span>
<span class="fc" id="L148">      int changeX = i * dirX;</span>
<span class="fc" id="L149">      int changeY = i * dirY;</span>
<span class="fc" id="L150">      int resX = (int) destX / GRIDSIZE + changeX;</span>
<span class="fc" id="L151">      int resY = (int) destY / GRIDSIZE + changeY;</span>
<span class="pc bpc" id="L152" title="1 of 12 branches missed.">      if (resX &gt;= 0 &amp;&amp; resX &lt; GRIDNUM &amp;&amp; (changeX != 0 || changeY != 0) &amp;&amp; resY &gt;= 0</span>
          &amp;&amp; resY &lt; GRIDNUM) {
<span class="fc" id="L154">        Square s = squares[resX][resY];</span>
<span class="fc" id="L155">        Piece destPiece = s.getPiece();</span>
<span class="fc bfc" id="L156" title="All 2 branches covered.">        if (destPiece == null) {</span>
<span class="fc bfc" id="L157" title="All 6 branches covered.">          if (!(this.code.contains(&quot;p&quot;) &amp;&amp; dirX != 0) &amp;&amp; occur - kingOccur == 0) {</span>
<span class="fc" id="L158">            preLegalMoves.add(new Move(curSquare, s, Move.NORMAL, this, null));</span>
<span class="fc" id="L159">            s.underControl(isWhite);</span>
          }
        } else {
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">          if (kingOccur &gt; 0) {</span>
<span class="nc" id="L163">            break;</span>
          }
<span class="fc bfc" id="L165" title="All 2 branches covered.">          if (destPiece.isWhitePiece() != this.isWhite) {</span>
<span class="fc bfc" id="L166" title="All 4 branches covered.">            if (!(this.code.contains(&quot;p&quot;) &amp;&amp; dirX == 0)) {</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">              if (destPiece.getCode().contains(&quot;k&quot;)) {</span>
<span class="fc bfc" id="L168" title="All 2 branches covered.">                if (occur == 0) {</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">                  attackers[this.isWhite ? 0 : 1].add(this);</span>
                } else {
<span class="fc" id="L171">                  prevPiece.setPinPiece(this);</span>
                }
<span class="fc" id="L173">                kingOccur++;</span>
              }
<span class="fc" id="L175">              prevPiece = destPiece;</span>
<span class="fc" id="L176">              occur++;</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">              if (occur &lt;= 1) {</span>
<span class="fc" id="L178">                preLegalMoves.add(new Move(curSquare, s, Move.CAPTURE, this, destPiece));</span>
<span class="fc" id="L179">                s.underControl(isWhite);</span>
              }
            } else {
              break;
            }
          } else {
<span class="fc" id="L185">            s.underControl(isWhite);</span>
<span class="fc" id="L186">            break;</span>
          }
<span class="fc bfc" id="L188" title="All 2 branches covered.">          if (occur &gt; 1) {</span>
<span class="fc" id="L189">            break;</span>
          }
        }
      }
    }
<span class="fc" id="L194">  }</span>

  public abstract void generateMove(Board curBoard);

  public void updatePreLegalMoves(Board curBoard) {
<span class="fc" id="L199">    preLegalMoves.removeAll(preLegalMoves);</span>
<span class="fc" id="L200">    validMoves.removeAll(validMoves);</span>
<span class="fc" id="L201">    generateMove(curBoard);</span>
<span class="fc" id="L202">  }</span>

  public double getValue() {
<span class="fc" id="L205">    return value;</span>
  }

  public void updateLegalMove(Board curBoard) {
<span class="fc bfc" id="L209" title="All 2 branches covered.">    CopyOnWriteArrayList&lt;Piece&gt; attackers = curBoard.getAttackers()[isWhite ? 1 : 0];</span>
<span class="fc" id="L210">    Square kingSquare = curBoard.getKing(isWhite).getSquare();</span>
    // Move king out of danger
<span class="fc bfc" id="L212" title="All 2 branches covered.">    if (this.code.contains(&quot;k&quot;)) {</span>
<span class="fc bfc" id="L213" title="All 2 branches covered.">      for (Move move : preLegalMoves) {</span>
<span class="fc bfc" id="L214" title="All 4 branches covered.">        if (!move.getEndSquare().isControl(!isWhite)) {</span>
<span class="fc" id="L215">          validMoves.add(move);</span>
        }
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">        if (move.getFlag() == Move.CASTLE</span>
<span class="nc bnc" id="L218" title="All 4 branches missed.">            &amp;&amp; (move.getSubMove().getSourcePiece().getPinPiece() != null || attackers.size() &gt; 0)) {</span>
<span class="nc" id="L219">          validMoves.remove(move);</span>
        }
<span class="fc" id="L221">      }</span>
<span class="fc" id="L222">      return;</span>
    }
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">    if (attackers.size() &gt; 1) {</span>
<span class="nc" id="L225">      return;</span>
<span class="fc bfc" id="L226" title="All 2 branches covered.">    } else if (attackers.size() == 1) {</span>
<span class="fc" id="L227">      Piece attacker = attackers.get(0);</span>
<span class="fc" id="L228">      Square attackerSquare = attacker.getSquare();</span>
      // Capture the attacking piece
<span class="fc bfc" id="L230" title="All 2 branches covered.">      if (attackerSquare.isControl(isWhite)) {</span>
<span class="fc" id="L231">        Move move = getMoveFromSquare(attackerSquare, false);</span>
<span class="fc bfc" id="L232" title="All 2 branches covered.">        if (move != null) {</span>
<span class="fc" id="L233">          validMoves.add(move);</span>
        }
      }

      // Block the attack
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">      if (!attacker.code.contains(&quot;p|n|c|g|k&quot;)) {</span>
<span class="fc bfc" id="L239" title="All 2 branches covered.">        for (Move move : preLegalMoves) {</span>
<span class="fc bfc" id="L240" title="All 2 branches covered.">          if (Board.checkOnWay(kingSquare, attackerSquare, move.getEndSquare())) {</span>
<span class="fc" id="L241">            validMoves.add(move);</span>
          }
<span class="fc" id="L243">        }</span>
      }
<span class="fc" id="L245">    } else {</span>
<span class="fc" id="L246">      validMoves.addAll(preLegalMoves);</span>
    }

<span class="fc bfc" id="L249" title="All 2 branches covered.">    if (pinPiece != null) {</span>
<span class="fc" id="L250">      validMoves.removeIf(</span>
<span class="fc bfc" id="L251" title="All 2 branches covered.">          move -&gt; !Board.checkOnWay(kingSquare, pinPiece.getSquare(), move.getEndSquare()));</span>
    }

<span class="fc" id="L254">  }</span>

  public Piece getPinPiece() {
<span class="nc" id="L257">    return pinPiece;</span>
  }


  protected void setHorseMove(Board curBoard, int range) {
<span class="fc" id="L262">    CopyOnWriteArrayList&lt;Piece&gt;[] attackers = curBoard.getAttackers();</span>
<span class="fc" id="L263">    Square[][] squares = curBoard.getSquareMat();</span>
<span class="fc" id="L264">    List&lt;Integer&gt; changeX = Arrays.asList(1, range);</span>
<span class="fc" id="L265">    List&lt;Integer&gt; changeY = Arrays.asList(range, 1);</span>
<span class="fc bfc" id="L266" title="All 2 branches covered.">    for (int i = 0; i &lt; DIRECTION_NUMBER; i++) {</span>
<span class="fc bfc" id="L267" title="All 2 branches covered.">      for (int j = 0; j &lt; changeX.size(); j++) {</span>
<span class="fc" id="L268">        int resX = (int) destX / GRIDSIZE + X_DIAGONAL_DIRECTION[i] * changeX.get(j);</span>
<span class="fc" id="L269">        int resY = (int) destY / GRIDSIZE + Y_DIAGONAL_DIRECTION[i] * changeY.get(j);</span>
<span class="fc bfc" id="L270" title="All 8 branches covered.">        if (resX &gt;= 0 &amp;&amp; resX &lt; GRIDNUM &amp;&amp; resY &gt;= 0 &amp;&amp; resY &lt; GRIDNUM) {</span>
<span class="fc" id="L271">          Square s = squares[resX][resY];</span>
<span class="fc" id="L272">          Piece destPiece = s.getPiece();</span>
<span class="fc bfc" id="L273" title="All 2 branches covered.">          if (destPiece == null) {</span>
<span class="fc" id="L274">            preLegalMoves.add(new Move(curSquare, s, Move.NORMAL, this, null));</span>
<span class="fc bfc" id="L275" title="All 2 branches covered.">          } else if (destPiece.isWhitePiece() != this.isWhite) {</span>
<span class="fc bfc" id="L276" title="All 2 branches covered.">            if (destPiece.getCode().contains(&quot;k&quot;)) {</span>
<span class="fc bfc" id="L277" title="All 2 branches covered.">              attackers[isWhite ? 0 : 1].add(this);</span>
            }
<span class="fc" id="L279">            preLegalMoves.add(new Move(curSquare, s, Move.CAPTURE, this, s.getPiece()));</span>
          }
<span class="fc" id="L281">          s.underControl(isWhite);</span>
        }
      }
    }
<span class="fc" id="L285">  }</span>

  protected void setRookMove(Board curBoard) {
<span class="fc bfc" id="L288" title="All 2 branches covered.">    for (int i = 0; i &lt; DIRECTION_NUMBER; i++) {</span>
<span class="fc" id="L289">      int dirX = X_STRAIGHT_DIRECTION[i];</span>
<span class="fc" id="L290">      int dirY = Y_STRAIGHT_DIRECTION[i];</span>
<span class="fc" id="L291">      straightMove(curBoard, dirX, dirY, GRIDNUM);</span>
    }
<span class="fc" id="L293">  }</span>

  protected void setBishopMove(Board curBoard) {
<span class="fc bfc" id="L296" title="All 2 branches covered.">    for (int i = 0; i &lt; DIRECTION_NUMBER; i++) {</span>
<span class="fc" id="L297">      int dirX = X_DIAGONAL_DIRECTION[i];</span>
<span class="fc" id="L298">      int dirY = Y_DIAGONAL_DIRECTION[i];</span>
<span class="fc" id="L299">      straightMove(curBoard, dirX, dirY, GRIDNUM);</span>
    }
<span class="fc" id="L301">  }</span>

  protected void setKingMove(Board curBoard) {
<span class="fc bfc" id="L304" title="All 2 branches covered.">    for (int i = 0; i &lt; DIRECTION_NUMBER; i++) {</span>
<span class="fc" id="L305">      int dirX = X_DIAGONAL_DIRECTION[i];</span>
<span class="fc" id="L306">      int dirY = Y_DIAGONAL_DIRECTION[i];</span>
<span class="fc" id="L307">      straightMove(curBoard, dirX, dirY, 1);</span>
<span class="fc" id="L308">      dirX = X_STRAIGHT_DIRECTION[i];</span>
<span class="fc" id="L309">      dirY = Y_STRAIGHT_DIRECTION[i];</span>
<span class="fc" id="L310">      straightMove(curBoard, dirX, dirY, 1);</span>
    }
<span class="fc" id="L312">  }</span>

  public void tick() {
<span class="nc" id="L315">    double movementSpeed = Piece.movementSpeed;</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">    if (overrideSpeed &gt; 0) {</span>
<span class="nc" id="L317">      movementSpeed = overrideSpeed;</span>
    }
<span class="nc" id="L319">    float distX = this.x - displayX;</span>
<span class="nc" id="L320">    float distY = this.y - displayY;</span>
<span class="nc" id="L321">    double distance = Math.sqrt(Math.pow(distX, 2) + Math.pow(distY, 2));</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">    if (distance &gt; movementSpeed) {</span>
<span class="nc" id="L323">      this.x += Math.cos(direction) * movementSpeed;</span>
<span class="nc" id="L324">      this.y += Math.sin(direction) * movementSpeed;</span>
    } else {
<span class="nc" id="L326">      this.x = this.destX;</span>
<span class="nc" id="L327">      this.y = this.destY;</span>
<span class="nc" id="L328">      overrideSpeed = 0;</span>
<span class="nc" id="L329">      moving = false;</span>
    }
<span class="nc" id="L331">  }</span>

  public boolean isWhitePiece() {
<span class="fc" id="L334">    return isWhite;</span>
  }

  public void setDestination(Square target) {
<span class="fc" id="L338">    this.curSquare = target;</span>
<span class="fc" id="L339">    this.destX = target.getX();</span>
<span class="fc" id="L340">    this.destY = target.getY();</span>
<span class="fc" id="L341">  }</span>

  public float getDesX() {
<span class="fc" id="L344">    return destX;</span>
  }

  public float getDesY() {
<span class="fc" id="L348">    return destY;</span>
  }

  public Move getMoveFromSquare(Square s, boolean legal) {
<span class="pc bpc" id="L352" title="1 of 2 branches missed.">    CopyOnWriteArrayList&lt;Move&gt; searchList = legal ? validMoves : preLegalMoves;</span>
<span class="fc bfc" id="L353" title="All 2 branches covered.">    for (Move m : searchList) {</span>
<span class="fc bfc" id="L354" title="All 2 branches covered.">      if (m.getEndSquare() == s) {</span>
<span class="fc" id="L355">        return m;</span>
      }
<span class="fc" id="L357">    }</span>
<span class="fc" id="L358">    return null;</span>
  }


  /**
   * Draws the object to the screen.
   *
   * @param app The window to draw onto.
   */
  public void draw(PApplet app) {
<span class="nc" id="L368">    tick();</span>
<span class="nc" id="L369">    app.image(this.sprite, this.x, this.y);</span>
<span class="nc" id="L370">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>